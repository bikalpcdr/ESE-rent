<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${room.title + ' - ESE-Rent'}">Room Details - ESE-Rent</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
    <!-- Include header fragment -->
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container py-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-white px-0">
                <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                <li class="breadcrumb-item"><a th:href="@{/rooms}">Rooms</a></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${room.title}">Room Details</li>
            </ol>
        </nav>
        
        <div class="room-details">
            <!-- Room Gallery -->
            <div class="room-gallery">
                <!-- If we have images, show the first one -->
                <div th:if="${not #lists.isEmpty(room.imageUrls)}" style="height: 100%; width: 100%;">
                    <img th:src="${room.imageUrls[0]}" alt="Room Image" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                
                <!-- If no images, show a placeholder -->
                <div th:if="${#lists.isEmpty(room.imageUrls)}" style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; background-color: #f2f2f2;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home text-secondary">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
            </div>
            
            <div class="row">
                <!-- Room Information -->
                <div class="col-md-8">
                    <div class="room-info">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h1 th:text="${room.title}">Room Title</h1>
                            <span class="badge badge-pill" 
                                th:classappend="${room.roomType.toString().equals('ENTIRE_APARTMENT') ? 'badge-primary' : 
                                                (room.roomType.toString().equals('PRIVATE_ROOM') ? 'badge-success' : 
                                                (room.roomType.toString().equals('SHARED_ROOM') ? 'badge-warning' : 'badge-info'))}"
                                th:text="${room.roomType.toString().replace('_', ' ')}">
                                Room Type
                            </span>
                        </div>
                        
                        <p class="text-muted" th:text="${room.address}">123 Main St, City</p>
                        
                        <div class="room-price mb-4">
                            <span th:text="${'$' + room.pricePerNight}">$50</span> / night
                        </div>
                        
                        <div class="mb-4">
                            <h5>Details</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Size:</strong> <span th:text="${room.size + ' m²'}">30 m²</span></p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Capacity:</strong> <span th:text="${room.capacity + ' ' + (room.capacity > 1 ? 'people' : 'person')}">2 people</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Description</h5>
                            <p th:text="${room.description}">Detailed description of the room...</p>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Amenities</h5>
                            <ul class="amenities-list">
                                <li th:each="amenity : ${#strings.arraySplit(room.amenities, ',')}">
                                    <span th:text="${amenity}">Amenity</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="mb-4">
                            <h5>About the Landlord</h5>
                            <div class="d-flex align-items-center">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                                <div>
                                    <h6 class="mb-0" th:text="${room.landlord.fullName}">Landlord Name</h6>
                                    <p class="text-muted mb-0">Joined: <span th:text="${#temporals.format(#dates.createNow(), 'MMM yyyy')}">Jan 2023</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Booking Form -->
                <div class="col-md-4">
                    <div class="booking-form sticky-top" style="top: 20px;">
                        <h4 class="mb-3">Book this room</h4>
                        
                        <form id="bookingForm" th:action="@{'/customer/rooms/' + ${room.id} + '/book'}" method="post" sec:authorize="hasRole('CUSTOMER')">
                            <div class="form-group">
                                <label for="checkInDate">Check-in Date</label>
                                <input type="date" class="form-control" id="checkInDate" name="checkInDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="checkOutDate">Check-out Date</label>
                                <input type="date" class="form-control" id="checkOutDate" name="checkOutDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="numberOfGuests">Number of Guests</label>
                                <select class="form-control" id="numberOfGuests" name="numberOfGuests">
                                    <option th:each="i : ${#numbers.sequence(1, room.capacity)}" th:value="${i}" th:text="${i}">1</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="specialRequests">Special Requests (Optional)</label>
                                <textarea class="form-control" id="specialRequests" name="specialRequests" rows="3"></textarea>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Price Details</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span th:text="${'$' + room.pricePerNight + ' x '}">$50 x </span>
                                        <span id="nightCount">0 nights</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between font-weight-bold">
                                        <span>Total</span>
                                        <span id="totalPrice">$0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">Book Now</button>
                        </form>
                        
                        <!-- Show login prompt for non-authenticated users -->
                        <div sec:authorize="!isAuthenticated()">
                            <div class="alert alert-info">
                                <p>You need to log in to book this room.</p>
                                <a th:href="@{/login}" class="btn btn-primary btn-block">Log In</a>
                                <a th:href="@{/register}" class="btn btn-outline-primary btn-block">Register</a>
                            </div>
                        </div>
                        
                        <!-- Show message for landlords -->
                        <div sec:authorize="hasRole('LANDLORD') && !hasRole('CUSTOMER')">
                            <div class="alert alert-info">
                                <p>You are logged in as a landlord. Switch to customer mode to book rooms.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include footer fragment -->
    <div th:replace="fragments/footer :: footer"></div>
    
    <!-- Custom script for booking form -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkInDateInput = document.getElementById('checkInDate');
            const checkOutDateInput = document.getElementById('checkOutDate');
            const nightCountSpan = document.getElementById('nightCount');
            const totalPriceSpan = document.getElementById('totalPrice');
            const pricePerNight = [[${room.pricePerNight}]];
            
            // Set min date to tomorrow for check-in
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            if (checkInDateInput) {
                checkInDateInput.min = tomorrowStr;
                
                // When check-in date changes, update min date for check-out
                checkInDateInput.addEventListener('change', function() {
                    const checkIn = new Date(this.value);
                    const nextDay = new Date(checkIn);
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    if (checkOutDateInput) {
                        checkOutDateInput.min = nextDay.toISOString().split('T')[0];
                        
                        // If current check-out date is now invalid, reset it
                        if (checkOutDateInput.value && new Date(checkOutDateInput.value) <= checkIn) {
                            checkOutDateInput.value = nextDay.toISOString().split('T')[0];
                        }
                        
                        // Update price calculation
                        updatePriceCalculation();
                    }
                });
            }
            
            if (checkOutDateInput) {
                // Update price calculation when check-out date changes
                checkOutDateInput.addEventListener('change', updatePriceCalculation);
            }
            
            // Function to update night count and total price
            function updatePriceCalculation() {
                if (checkInDateInput.value && checkOutDateInput.value) {
                    const checkIn = new Date(checkInDateInput.value);
                    const checkOut = new Date(checkOutDateInput.value);
                    
                    // Calculate nights between dates
                    const timeDiff = checkOut.getTime() - checkIn.getTime();
                    const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
                    
                    if (nights > 0) {
                        nightCountSpan.textContent = nights + (nights === 1 ? ' night' : ' nights');
                        
                        // Calculate total price
                        const total = nights * pricePerNight;
                        totalPriceSpan.textContent = '$' + total;
                    }
                }
            }
        });
    </script>
</body>
</html>
